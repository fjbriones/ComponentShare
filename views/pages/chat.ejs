<html>
	<head>
		<title>Chat</title>
		<meta name = "viewport" content="width = device-width, initial-scale = 1"/>
		<link rel="stylesheet" href="style.css"/>
		 <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
   		 <script src="/socket.io/socket.io.js"  type="text/javascript"></script>

	</head>
	<body>
		<input type="hidden" id="userId">
		<input type="hidden" id="user_id" placeholder="myID"><input id="user_to" type="hidden" placeholder="hisID"><br/>
		<input id="username" type="hidden" placeholder="my name">
		<h1> Chat! </h1>
		<form>
			<input id = "message" type="text" placeholder="message">
			<input type="button" id="send" value="Send">
		</form>

		<ul id="typing"></ul>
		<ul id="thread"></ul>

		 <script>
   		 	//initiate socket connection
			var socket = io.connect('http://10.158.3.101:3000');
			var myID = 0;
			var hisID = 0;
			var curUserId = <%= userId %>;
			socket.on("matchid", function(data){
				console.log(curUserId);
				console.log("owner id: " + data.own_id);
				console.log("req id: " + data.req_id);
				if(data.own_id == curUserId){
					$("#user_id").val(data.own_id);
					$("#username").val(data.own_id);
					$("#user_to").val(data.req_id);
					myID = data.own_id;	
					hisID = data.req_id;
				}else{
					$("#user_id").val(data.req_id);
					$("#username").val(data.req_id);
					$("#user_to").val(data.own_id);
					hisID = data.own_id;
					myID = data.req_id;
				}
				
			});

			socket.on("thread", function(data) {
				$("#typing").html("");
				if(data.user_to == myID && data.user_id == hisID){
					$("#thread").append("<li><b>" +data.username+ "</b> : " + data.message + "</li>");
				} else if (data.user_id == myID && data.user_to == hisID) {
					$("#thread").append("<li><b>" +data.username+ "</b> : " + data.message + "</li>");
				}
			});

			//Show "typing..." message
			socket.on("typing", function(data){
				if(data.user_to == myID && data.user_id ==hisID){
					if(data.status == true){
						$("#typing").html("<li> typing...</li>");
					}else{
						$("#typing").html("");
					}
				}
			});

			//emit form contents to socket
			$("#send").click(function(){
				console.log('pressed');
				var user_id = $("#user_id").val();
				var username = $("#username").val();
				var user_to = $("#user_to").val();
				var message = $("#message").val();

				var msg = {
					user_id : user_id,
					username : username,
					user_to : user_to,
					message : message,
				};
				socket.emit("messages", msg);
				console.log(msg);
				$("#message").val(" ");
				return false;
			});

			var timeout;
			function timeoutFunction(){
				var typo = {
					user_to : hisID,
					user_id : myID,
					status: false
				}
				socket.emit("is_typing", typo);
			}

			$("#message").keypress(function(e){
				if(e.which !== 13){
					var typo = {
						user_to : hisID,
						user_id : myID,
						status: true
					}
					socket.emit("is_typing", typo);
					clearTimeout(timeout);
					timeout = setTimeout(function() {}, 2000);

				}else{
					clearTimeout(timeout);
					timeoutFunction();
				}
			});

   		 </script>
	</body>
	</html>
